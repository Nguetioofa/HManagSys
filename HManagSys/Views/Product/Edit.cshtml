@model HManagSys.Models.ViewModels.Stock.EditProductViewModel
@{
    ViewData["Title"] = $"Modifier - {Model.Name}";
}

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-action="Index">
                    <i class="fas fa-boxes"></i>
                    Produits
                </a>
            </li>
            <li class="breadcrumb-item">
                <a asp-action="Details" asp-route-id="@Model.Id">@Model.Name</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Modifier</li>
        </ol>
    </nav>

    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-edit text-warning"></i>
                        Modifier le Produit
                    </h1>
                    <p class="text-muted mb-0">
                        Modification de « <strong>@Model.Name</strong> »
                        @if (Model.CentersWithStock > 0)
                        {
                            <span class="badge bg-info ms-2">Stock actif dans @Model.CentersWithStock centre(s)</span>
                        }
                    </p>
                </div>
                <div>
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-info">
                        <i class="fas fa-eye"></i>
                        Voir détails
                    </a>
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Retour à la liste
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertes d'information -->
    @if (Model.CentersWithStock > 0)
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Information :</strong> Ce produit a du stock dans @Model.CentersWithStock centre(s).
            Toute modification du nom ou de l'unité de mesure sera reflétée dans tout le système.
        </div>
    }

    @if (Model.MovementCount > 0)
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Attention :</strong> Ce produit a @Model.MovementCount mouvement(s) de stock.
            La modification de l'unité de mesure peut affecter l'historique existant.
        </div>
    }

    <!-- Formulaire de modification -->
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-pencil-alt"></i>
                        Informations du produit
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post" novalidate id="editProductForm">
                        <input asp-for="Id" type="hidden" />
                        <input asp-for="CentersWithStock" type="hidden" />
                        <input asp-for="MovementCount" type="hidden" />

                        <!-- Nom du produit -->
                        <div class="mb-4">
                            <label asp-for="Name" class="form-label required">
                                <i class="fas fa-cube text-primary"></i>
                                Nom du produit
                            </label>
                            <input asp-for="Name" class="form-control form-control-lg"
                                   placeholder="Ex: Paracétamol 500mg, Compresses stériles..."
                                   maxlength="200" id="productName">
                            <span asp-validation-for="Name" class="text-danger small"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i>
                                Nom descriptif et unique du produit (max 200 caractères)
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label asp-for="Description" class="form-label">
                                <i class="fas fa-align-left text-secondary"></i>
                                Description
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="3"
                                      placeholder="Description détaillée du produit, posologie, indications..."
                                      maxlength="1000" id="productDescription"></textarea>
                            <span asp-validation-for="Description" class="text-danger small"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i>
                                Description optionnelle pour donner plus de détails (max 1000 caractères)
                            </div>
                        </div>

                        <!-- Catégorie -->
                        <div class="mb-4">
                            <label asp-for="ProductCategoryId" class="form-label required">
                                <i class="fas fa-tags text-warning"></i>
                                Catégorie
                            </label>
                            <div class="input-group">
                                <select asp-for="ProductCategoryId" class="form-select">
                                    <option value="">-- Sélectionner une catégorie --</option>
                                    @foreach (var category in Model.AvailableCategories)
                                    {
                                        <option value="@category.Id" selected="@(category.Id == Model.ProductCategoryId)">
                                            @category.Name
                                        </option>
                                    }
                                </select>
                                <a asp-controller="ProductCategory" asp-action="Create" 
                                   class="btn btn-outline-secondary" title="Nouvelle catégorie" target="_blank">
                                    <i class="fas fa-plus"></i>
                                </a>
                            </div>
                            <span asp-validation-for="ProductCategoryId" class="text-danger small"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i>
                                Choisissez la catégorie appropriée pour organiser le stock
                            </div>
                        </div>

                        <!-- Unité de mesure -->
                        <div class="mb-4">
                            <label asp-for="UnitOfMeasure" class="form-label required">
                                <i class="fas fa-balance-scale text-info"></i>
                                Unité de mesure
                                @if (Model.MovementCount > 0)
                                {
                                    <span class="badge bg-warning ms-2" title="@Model.MovementCount mouvements utilisent cette unité">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        En utilisation
                                    </span>
                                }
                            </label>
                            <div class="input-group">
                                <input asp-for="UnitOfMeasure" class="form-control"
                                       placeholder="Ex: pièce, boîte, flacon, tube..."
                                       maxlength="50" list="unitSuggestions" id="unitOfMeasure">
@*                                 <datalist id="unitSuggestions">
                                    <option value="pièce">
                                    <option value="boîte">
                                    <option value="flacon">
                                    <option value="tube">
                                    <option value="ampoule">
                                    <option value="sachet">
                                    <option value="comprimé">
                                    <option value="gélule">
                                    <option value="ml">
                                    <option value="litre">
                                    <option value="gramme">
                                    <option value="kilogramme">
                                </datalist> *@
                                <span class="input-group-text">
                                    <i class="fas fa-list" title="Unités communes"></i>
                                </span>
                            </div>
                            <span asp-validation-for="UnitOfMeasure" class="text-danger small"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i>
                                Comment le produit est-il compté/mesuré ? (max 50 caractères)
                                @if (Model.MovementCount > 0)
                                {
                                    <br><strong>Attention :</strong> <span> Modifier l'unité peut affecter l'interprétation de l'historique existant.</span>
                                }
                            </div>
                        </div>

                        <!-- Prix de vente -->
                        <div class="mb-4">
                            <label asp-for="SellingPrice" class="form-label required">
                                <i class="fas fa-tag text-success"></i>
                                Prix de vente unitaire
                            </label>
                            <div class="input-group">
                                <input asp-for="SellingPrice" class="form-control" type="number" step="0.01" min="0"
                                       placeholder="0.00" id="sellingPrice">
                                <span class="input-group-text">FCFA</span>
                            </div>
                            <span asp-validation-for="SellingPrice" class="text-danger small"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i>
                                Prix de vente par unité en Francs CFA
                            </div>
                        </div>

                        <!-- Statut -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input asp-for="IsActive" class="form-check-input" id="isActiveSwitch">
                                <label asp-for="IsActive" class="form-check-label" for="isActiveSwitch">
                                    <i id="statusIcon" class="fas fa-check-circle text-success"></i>
                                    <span id="statusText">Produit actif</span>
                                </label>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle text-info"></i>
                                Seuls les produits actifs sont disponibles pour la vente et les soins
                                @if (Model.CentersWithStock > 0)
                                {
                                    <br>
                                    <strong>Note :</strong>

                                    <span> Désactiver ce produit le rendra indisponible mais conservera le stock existant. </span>
                                }
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-info me-md-2">
                                <i class="fas fa-eye"></i>
                                Voir détails
                            </a>
                            <a asp-action="Index" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times"></i>
                                Annuler
                            </a>
                            <button type="submit" class="btn btn-warning text-dark" id="submitButton">
                                <span id="submitSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                                <i class="fas fa-save"></i>
                                Enregistrer les modifications
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Informations supplémentaires -->
    <div class="row mt-4">
        <div class="col-lg-8 col-xl-6 mx-auto">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-info-circle text-info"></i>
                        Informations sur ce produit
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Centres avec stock :</strong><br>
                                <span class="badge bg-primary">@Model.CentersWithStock</span> centre(s)
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Mouvements de stock :</strong><br>
                                <span class="badge @(Model.MovementCount > 0 ? "bg-warning" : "bg-secondary")">
                                    @Model.MovementCount
                                </span> mouvement(s)
                            </small>
                        </div>
                    </div>

                    @if (Model.CentersWithStock > 0 || Model.MovementCount > 0)
                    {
                        <hr class="my-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <small class="text-muted">
                                <i class="fas fa-chart-line text-secondary"></i>
                                Voulez-vous voir l'historique détaillé ?
                            </small>
                            <a asp-action="Details" asp-route-id="@Model.Id" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-history"></i>
                                Voir l'historique
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @* Validation côté client *@
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Variables pour tracking des changements
        const originalValues = {
            name: '@Html.Raw(Model.Name?.Replace("'", "\\'"))',
            description: '@Html.Raw(Model.Description?.Replace("'", "\\'"))',
            categoryId: @Model.ProductCategoryId,
            unitOfMeasure: '@Html.Raw(Model.UnitOfMeasure?.Replace("'", "\\'"))',
            sellingPrice: @Model.SellingPrice,
            isActive: @Model.IsActive.ToString().ToLower()
        };

        // Auto-formatage du prix
        document.getElementById('sellingPrice').addEventListener('blur', function() {
            const value = parseFloat(this.value);
            if (!isNaN(value)) {
                this.value = value.toFixed(2);
            }
        });

        // Gestion du switch actif/inactif avec feedback visuel
        function updateStatusDisplay() {
            const isActiveSwitch = document.getElementById('isActiveSwitch');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');

            if (isActiveSwitch.checked) {
                statusIcon.className = 'fas fa-check-circle text-success';
                statusText.textContent = 'Produit actif';
                statusText.className = '';
            } else {
                statusIcon.className = 'fas fa-pause-circle text-warning';
                statusText.textContent = 'Produit inactif';
                statusText.className = 'text-warning';
            }
        }

        // Initialiser l'affichage au chargement
        updateStatusDisplay();

        // Écouter les changements
        document.getElementById('isActiveSwitch').addEventListener('change', function() {
            updateStatusDisplay();

            // Avertissement si désactivation avec stock
            const centersWithStock = @Model.CentersWithStock;
            if (!this.checked && centersWithStock > 0) {
                if (!confirm(`Attention : Désactiver ce produit le rendra indisponible dans ${centersWithStock} centre(s) avec du stock.\n\nContinuer ?`)) {
                    this.checked = true;
                    updateStatusDisplay();
                }
            }
        });

        // Validation en temps réel du nom
        document.getElementById('productName').addEventListener('blur', function() {
            const value = this.value.trim();
            if (value.length > 0 && value.length < 3) {
                this.classList.add('is-invalid');
                showFieldError(this, 'Le nom doit contenir au moins 3 caractères');
            } else {
                this.classList.remove('is-invalid');
                hideFieldError(this);
            }
        });

        // Auto-resize du textarea description
        const description = document.getElementById('productDescription');
        description.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        // Initialiser la taille du textarea
        description.style.height = description.scrollHeight + 'px';

        // Compteur de caractères
        function addCharacterCounter(fieldId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = document.createElement('div');
            counter.className = 'text-muted small text-end mt-1';
            counter.style.fontSize = '0.875em';
            field.parentNode.appendChild(counter);

            function updateCounter() {
                const remaining = maxLength - field.value.length;
                counter.textContent = `${field.value.length}/${maxLength} caractères`;

                if (remaining < 50) {
                    counter.classList.add('text-warning');
                    counter.classList.remove('text-muted');
                } else if (remaining < 0) {
                    counter.classList.add('text-danger');
                    counter.classList.remove('text-muted', 'text-warning');
                } else {
                    counter.classList.add('text-muted');
                    counter.classList.remove('text-warning', 'text-danger');
                }
            }

            field.addEventListener('input', updateCounter);
            updateCounter(); // Initial call
        }

        // Ajouter compteurs pour nom et description
        addCharacterCounter('productName', 200);
        addCharacterCounter('productDescription', 1000);

        // Validation du prix
        document.getElementById('sellingPrice').addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (value < 0) {
                this.classList.add('is-invalid');
                showFieldError(this, 'Le prix doit être positif');
            } else if (value > 1000000) {
                this.classList.add('is-invalid');
                showFieldError(this, 'Le prix semble trop élevé, veuillez vérifier');
            } else {
                this.classList.remove('is-invalid');
                hideFieldError(this);
            }
        });

        // Avertissement modification unité de mesure
        document.getElementById('unitOfMeasure').addEventListener('change', function() {
            const movementCount = @Model.MovementCount;
            const originalUnit = '@Html.Raw(Model.UnitOfMeasure?.Replace("'", "\\'"))';
            
            if (movementCount > 0 && this.value !== originalUnit) {
                if (!confirm(`Attention : Ce produit a ${movementCount} mouvement(s) de stock avec l'unité "${originalUnit}".\n\nModifier l'unité peut rendre l'historique confus.\n\nContinuer quand même ?`)) {
                    this.value = originalUnit;
                }
            }
        });

        // Détection des changements non sauvegardés
        function hasUnsavedChanges() {
            const current = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                categoryId: parseInt(document.querySelector('select[name="ProductCategoryId"]').value) || 0,
                unitOfMeasure: document.getElementById('unitOfMeasure').value,
                sellingPrice: parseFloat(document.getElementById('sellingPrice').value) || 0,
                isActive: document.getElementById('isActiveSwitch').checked
            };

            return JSON.stringify(current) !== JSON.stringify(originalValues);
        }

        // Avertissement avant de quitter la page
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = 'Vous avez des modifications non sauvegardées. Êtes-vous sûr de vouloir quitter ?';
            }
        });

        // Gestion du formulaire
        document.getElementById('editProductForm').addEventListener('submit', function(e) {
            const submitButton = document.getElementById('submitButton');
            const spinner = document.getElementById('submitSpinner');

            // Désactiver le bouton et afficher le spinner
            submitButton.disabled = true;
            spinner.classList.remove('d-none');
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sauvegarde en cours...';

            // Validation finale
            if (!validateForm()) {
                e.preventDefault();
                // Réactiver le bouton
                submitButton.disabled = false;
                spinner.classList.add('d-none');
                submitButton.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
                return false;
            }

            // Confirmation si modifications importantes
            const centersWithStock = @Model.CentersWithStock;
            const movementCount = @Model.MovementCount;
            const unitChanged = document.getElementById('unitOfMeasure').value !== originalValues.unitOfMeasure;

            if ((centersWithStock > 0 || movementCount > 0) && unitChanged) {
                if (!confirm('Attention : Vous avez modifié l\'unité de mesure d\'un produit avec stock/mouvements existants.\n\nCela peut affecter l\'interprétation des données historiques.\n\nConfirmer la modification ?')) {
                    e.preventDefault();
                    submitButton.disabled = false;
                    spinner.classList.add('d-none');
                    submitButton.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
                    return false;
                }
            }

            // Supprimer l'avertissement beforeunload lors de la soumission
            window.removeEventListener('beforeunload', arguments.callee);
        });

        // Fonction de validation complète
        function validateForm() {
            let isValid = true;
            const fields = [
                { id: 'productName', required: true, minLength: 3 },
                { id: 'ProductCategoryId', required: true },
                { id: 'unitOfMeasure', required: true, minLength: 1 },
                { id: 'sellingPrice', required: true, min: 0 }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.id) || document.querySelector(`[name="${field.id}"]`);
                if (!element) return;

                let fieldValid = true;
                let errorMessage = '';

                // Validation required
                if (field.required && !element.value.trim()) {
                    fieldValid = false;
                    errorMessage = 'Ce champ est obligatoire';
                }

                // Validation minLength
                if (fieldValid && field.minLength && element.value.trim().length < field.minLength) {
                    fieldValid = false;
                    errorMessage = `Minimum ${field.minLength} caractères`;
                }

                // Validation min pour les nombres
                if (fieldValid && field.min !== undefined && parseFloat(element.value) < field.min) {
                    fieldValid = false;
                    errorMessage = `La valeur doit être supérieure ou égale à ${field.min}`;
                }

                if (!fieldValid) {
                    element.classList.add('is-invalid');
                    showFieldError(element, errorMessage);
                    isValid = false;
                } else {
                    element.classList.remove('is-invalid');
                    hideFieldError(element);
                }
            });

            return isValid;
        }

        // Fonctions utilitaires pour les erreurs
        function showFieldError(element, message) {
            // Supprimer l'erreur existante
            hideFieldError(element);

            // Créer le message d'erreur
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.textContent = message;
            element.parentNode.appendChild(errorDiv);
        }

        function hideFieldError(element) {
            const existingError = element.parentNode.querySelector('.invalid-feedback');
            if (existingError) {
                existingError.remove();
            }
        }
    </script>
}

@section Styles {
    <style>
        .required::after {
            content: '*';
            color: #dc3545;
            margin-left: 4px;
        }

        .form-control-lg {
            font-size: 1.125rem;
            padding: 0.75rem 1rem;
        }

        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
        }

        .card-header.bg-warning {
            background-color: #ffc107 !important;
            color: #000 !important;
        }

        .form-check-label {
            font-weight: 500;
        }

        .form-text {
            margin-top: 0.5rem;
        }

        .breadcrumb-item + .breadcrumb-item::before {
            content: var(--bs-breadcrumb-divider, ">");
        }

        /* Animation pour les transitions de couleur du switch */
        .form-check-label span {
            transition: color 0.3s ease;
        }

        /* Amélioration des styles des champs invalides */
        .form-control.is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.7.7-1.4 1.4 1.4 1.4-.7.7L4.4 6l1.4-1.4z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        .form-select.is-invalid {
            border-color: #dc3545;
        }

        /* Style pour les alertes avec bordure à gauche */
        .alert {
            border-left: 4px solid;
        }

        .alert-info {
            border-left-color: #0dcaf0;
        }

        .alert-warning {
            border-left-color: #ffc107;
        }

        /* Animation du bouton de soumission */
        .btn:disabled {
            opacity: 0.65;
        }

        /* Amélioration des cartes */
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .card-header {
            border-radius: 0.75rem 0.75rem 0 0 !important;
        }

        /* Focus amélioré */
        .form-control:focus,
        .form-select:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* Indicateur de champ modifié (optionnel) */
        .form-control.modified {
            background-color: #fff3cd;
        }
    </style>
}