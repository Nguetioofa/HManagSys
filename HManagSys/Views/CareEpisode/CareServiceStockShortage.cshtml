@using HManagSys.Models.ViewModels
@model CareServiceStockShortageViewModel
@{
    ViewData["Title"] = "Stock insuffisant pour le service de soin";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">Épisodes de soins</a></li>
            <li class="breadcrumb-item"><a asp-action="Details" asp-route-id="@Model.CareServiceModel.CareEpisodeId">Détails</a></li>
            <li class="breadcrumb-item"><a asp-action="AddCareService" asp-route-episodeId="@Model.CareServiceModel.CareEpisodeId">Ajout service</a></li>
            <li class="breadcrumb-item active">Stock insuffisant</li>
        </ol>
    </nav>
    <div>
        <a asp-action="Details" asp-route-id="@Model.CareServiceModel.CareEpisodeId" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour
        </a>
    </div>
</div>

<div class="alert alert-danger">
    <div class="d-flex">
        <div class="me-3">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
        </div>
        <div>
            <h4 class="alert-heading">Stock insuffisant</h4>
            <p class="mb-0">Le service de soin ne peut pas être ajouté car le stock est insuffisant pour certains produits.</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Informations sur le service -->
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> Informations du service</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted">Patient</label>
                        <div class="fw-bold">@Model.CareServiceModel.PatientName</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted">Type de soin</label>
                        <div class="fw-bold">
                            @(Model.CareServiceModel.CareTypeOptions.FirstOrDefault(c => c.Value == Model.CareServiceModel.CareTypeId.ToString())?.Text ?? "N/A")
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted">Date du service</label>
                        <div class="fw-bold">@Model.CareServiceModel.ServiceDate.ToString("dd/MM/yyyy HH:mm")</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted">Coût</label>
                        <div class="fw-bold">@Model.CareServiceModel.Cost.ToString("N0") FCFA</div>
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(Model.CareServiceModel.Notes))
                {
                    <div class="mb-3">
                        <label class="form-label text-muted">Notes</label>
                        <div class="bg-light p-2 rounded">@Model.CareServiceModel.Notes</div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Ruptures de stock -->
    <div class="col-md-6">
        <div class="card shadow-sm mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0"><i class="fas fa-inventory"></i> Produits en rupture</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Produit</th>
                                <th>Quantité demandée</th>
                                <th>Quantité disponible</th>
                                <th>Manquant</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ShortageItems)
                            {
                                <tr>
                                    <td>@item.ProductName</td>
                                    <td>@item.RequestedQuantity.ToString("N2") @item.UnitOfMeasure</td>
                                    <td>@item.AvailableQuantity.ToString("N2") @item.UnitOfMeasure</td>
                                    <td class="text-danger">@item.ShortageAmount.ToString("N2") @item.UnitOfMeasure</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@if (ViewBag.IsSuperAdmin == true)
{
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning">
            <h5 class="card-title mb-0"><i class="fas fa-user-shield"></i> Actions administrateur</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-circle"></i> En tant que SuperAdmin, vous pouvez forcer l'ajout du service même en cas de stock insuffisant.
                Cette action sera journalisée et auditée.
            </div>

            <form asp-action="ForceAddCareService" method="post">
                @Html.AntiForgeryToken()

                <!-- Champs cachés pour préserver les données du formulaire original -->
                <input type="hidden" asp-for="CareServiceModel.CareEpisodeId" />
                <input type="hidden" asp-for="CareServiceModel.PatientName" />
                <input type="hidden" asp-for="CareServiceModel.CareTypeId" />
                <input type="hidden" asp-for="CareServiceModel.AdministeredBy" />
                <input type="hidden" asp-for="CareServiceModel.ServiceDate" />
                <input type="hidden" asp-for="CareServiceModel.Duration" />
                <input type="hidden" asp-for="CareServiceModel.Notes" />
                <input type="hidden" asp-for="CareServiceModel.Cost" />

                @if (Model.CareServiceModel.Products != null)
                {
                    for (int i = 0; i < Model.CareServiceModel.Products.Count; i++)
                    {
                        <input type="hidden" name="Products[@i].ProductId" value="@Model.CareServiceModel.Products[i].ProductId" />
                        <input type="hidden" name="Products[@i].QuantityUsed" value="@Model.CareServiceModel.Products[i].QuantityUsed" />
                        <input type="hidden" name="Products[@i].UnitCost" value="@Model.CareServiceModel.Products[i].UnitCost" />
                    }
                }

                <div class="form-group mb-3">
                    <label for="reason" class="form-label">Raison de l'ajout forcé</label>
                    <textarea id="reason" name="reason" class="form-control" rows="3" required
                          placeholder="Veuillez indiquer la raison de cette action exceptionnelle..."></textarea>
                    <div class="form-text">
                        Cette information sera enregistrée dans le journal d'audit.
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle"></i> Forcer l'ajout du service
                    </button>
                </div>
            </form>
        </div>
    </div>
}

<div class="d-flex justify-content-between mt-4">
    <a asp-action="AddCareService" asp-route-episodeId="@Model.CareServiceModel.CareEpisodeId" class="btn btn-outline-primary">
        <i class="fas fa-undo"></i> Modifier les produits
    </a>

    <div class="btn-group">
        <a asp-action="Details" asp-route-id="@Model.CareServiceModel.CareEpisodeId" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Retour à l'épisode
        </a>
        <a asp-controller="Stock" asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-boxes"></i> Gérer les stocks
        </a>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Ajouter ici du JavaScript si nécessaire
        });
    </script>
}