@using HManagSys.Models.ViewModels
@model DashboardViewModel
@{
    ViewData["Title"] = "Tableau de bord";
    var now = DateTime.Now;
    var greeting = now.Hour < 12 ? "Bonjour" : now.Hour < 18 ? "Bon après-midi" : "Bonsoir";
}

<div class="container-fluid">
    <!-- En-tête de bienvenue -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h3 mb-1">@greeting, @Model.User.FirstName</h1>
                            <p class="mb-0">
                                <i class="fas fa-hospital"></i>
                                @Model.Center.Name
                                <span class="ms-3">
                                    <i class="fas fa-user-tag"></i>
                                    @Model.CurrentRole
                                </span>
                            </p>
                        </div>
                        <div class="col-md-4 text-end d-none d-md-block">
                            <i class="fas fa-tachometer-alt fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <p class="text-white-50 small mb-1">Patients aujourd'hui</p>
                            <h4 class="mb-0" id="patients-count">--</h4>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-info-darker d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" asp-controller="Patient" asp-action="Index">Voir les détails</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <p class="text-white-50 small mb-1">Ventes du jour</p>
                            <h4 class="mb-0" id="sales-amount">--</h4>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-cash-register fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-success-darker d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="#">Voir les détails</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <p class="text-white-50 small mb-1">Alertes stock</p>
                            <h4 class="mb-0" id="stock-alerts">--</h4>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-warning-darker d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" asp-controller="Stock" asp-action="Alerts">Voir les détails</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-purple text-white h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <p class="text-white-50 small mb-1">Examens en attente</p>
                            <h4 class="mb-0" id="pending-exams">--</h4>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-microscope fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-purple-darker d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" asp-controller="Examination" asp-action="Pending">Voir les détails</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Actions rapides -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt text-primary"></i>
                        Actions rapides
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-controller="Patient" asp-action="Create" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus"></i>
                            Nouveau Patient
                        </a>
                        <a asp-controller="Sale" asp-action="Create" class="btn btn-outline-success">
                            <i class="fas fa-cash-register"></i>
                            Nouvelle Vente
                        </a>
                        <a asp-controller="Prescription" asp-action="Create" class="btn btn-outline-info">
                            <i class="fas fa-prescription"></i>
                            Créer Prescription
                        </a>
                        <a asp-controller="Examination" asp-action="Create" class="btn btn-outline-warning">
                            <i class="fas fa-microscope"></i>
                            Demander Examen
                        </a>
                        <a asp-controller="Dashboard" asp-action="Medical" class="btn btn-outline-secondary">
                            <i class="fas fa-chart-line"></i>
                            Tableau de bord médical
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activités récentes -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history text-success"></i>
                        Activités récentes
                    </h5>
                </div>
                <div class="card-body">
                    <div id="activity-loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2">Chargement des activités récentes...</p>
                    </div>
                    <div id="activity-content" class="table-responsive" style="display: none;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Heure</th>
                                    <th>Action</th>
                                    <th>Patient</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activities">
                                <!-- Les activités seront chargées ici dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                    <div id="activity-error" class="alert alert-warning text-center" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> Impossible de charger les activités récentes.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques et informations supplémentaires -->
    <div class="row">
        <!-- Alertes stock -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        Alertes de stock
                    </h5>
                </div>
                <div class="card-body">
                    <div id="stock-loading" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-warning" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 mb-0">Chargement des alertes...</p>
                    </div>
                    <div id="stock-content" style="display: none;">
                        <div id="stock-alerts-container">
                            <!-- Les alertes seront chargées ici -->
                        </div>
                        <div class="mt-3">
                            <a asp-controller="Stock" asp-action="Index" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye"></i>
                                Voir tous les stocks
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rendez-vous à venir -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt text-info"></i>
                        Plannification du jour
                    </h5>
                </div>
                <div class="card-body">
                    <div id="schedule-loading" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-info" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 mb-0">Chargement des rendez-vous...</p>
                    </div>
                    <div id="schedule-content" class="timeline" style="display: none;">
                        <!-- Les rendez-vous seront chargés ici -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Fonction pour formater les nombres avec séparateur de milliers
        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR').format(num);
        }

        // Fonction pour formater les montants en FCFA
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';
        }

        // Fonction pour formater les dates
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        // Charger les données du tableau de bord au chargement de la page
        $(document).ready(function() {
            loadDashboardData();
            loadRecentActivities();
            loadStockAlerts();
            loadDailySchedule();
        });

        // Fonction pour charger les données du tableau de bord
        function loadDashboardData() {
            $.ajax({
                url: '@Url.Action("GetDashboardData")',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        const data = response.data;

                        // Mise à jour des compteurs
                        $('#patients-count').text(formatNumber(data.todayPatientsCount));
                        $('#sales-amount').text(formatCurrency(data.todaySalesAmount));
                        $('#stock-alerts').text(formatNumber(data.stockAlertsCount));
                        $('#pending-exams').text(formatNumber(data.pendingExamsCount));
                    } else {
                        console.error('Erreur lors du chargement des données du tableau de bord:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erreur lors du chargement des données du tableau de bord:', error);
                }
            });
        }

        // Fonction pour charger les activités récentes
        function loadRecentActivities() {
            $('#activity-loading').show();
            $('#activity-content').hide();
            $('#activity-error').hide();

            $.ajax({
                url: '@Url.Action("GetRecentActivities")',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    $('#activity-loading').hide();

                    if (response.success) {
                        const activities = response.data;
                        let html = '';

                        if (activities.length === 0) {
                            html = '<tr><td colspan="4" class="text-center">Aucune activité récente</td></tr>';
                        } else {
                            activities.forEach(function(activity) {
                                html += `
                                    <tr>
                                        <td>${formatTime(activity.activityDate)}</td>
                                        <td><i class="fas ${activity.activityTypeIcon} text-primary"></i> ${activity.description}</td>
                                        <td>${activity.patientName}</td>
                                        <td><span class="badge ${activity.statusBadgeClass}">${activity.status}</span></td>
                                    </tr>
                                `;
                            });
                        }

                        $('#recent-activities').html(html);
                        $('#activity-content').show();
                    } else {
                        $('#activity-error').show();
                        console.error('Erreur lors du chargement des activités récentes:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#activity-loading').hide();
                    $('#activity-error').show();
                    console.error('Erreur lors du chargement des activités récentes:', error);
                }
            });
        }

        // Fonction pour charger les alertes de stock
        function loadStockAlerts() {
            $('#stock-loading').show();
            $('#stock-content').hide();

            $.ajax({
                url: '@Url.Action("GetStockAlerts")',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    $('#stock-loading').hide();

                    if (response.success) {
                        const alerts = response.data;
                        let html = '';

                        if (alerts.length === 0) {
                            html = '<div class="alert alert-success">Aucune alerte de stock à signaler</div>';
                        } else {
                            alerts.forEach(function(alert) {
                                const badgeClass = alert.quantity <= 0 ? 'bg-danger' : 'bg-warning';
                                html += `
                                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-2">
                                        <span>${alert.productName}</span>
                                        <span class="badge ${badgeClass}">${alert.quantity} ${alert.unitOfMeasure}</span>
                                    </div>
                                `;
                            });
                        }

                        $('#stock-alerts-container').html(html);
                        $('#stock-content').show();
                    } else {
                        $('#stock-alerts-container').html('<div class="alert alert-warning">Impossible de charger les alertes de stock</div>');
                        $('#stock-content').show();
                        console.error('Erreur lors du chargement des alertes de stock:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#stock-loading').hide();
                    $('#stock-alerts-container').html('<div class="alert alert-warning">Impossible de charger les alertes de stock</div>');
                    $('#stock-content').show();
                    console.error('Erreur lors du chargement des alertes de stock:', error);
                }
            });
        }

        // Fonction pour charger la plannification du jour
        function loadDailySchedule() {
            $('#schedule-loading').show();
            $('#schedule-content').hide();

            $.ajax({
                url: '@Url.Action("GetDailySchedule")',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    $('#schedule-loading').hide();

                    if (response.success) {
                        const schedule = response.data;
                        let html = '';

                        if (schedule.length === 0) {
                            html = '<div class="text-center py-3">Aucun rendez-vous planifié aujourd\'hui</div>';
                        } else {
                            schedule.forEach(function(item) {
                                let markerClass = '';

                                switch(item.type) {
                                    case 'Consultation':
                                        markerClass = 'bg-primary';
                                        break;
                                    case 'Examen':
                                        markerClass = 'bg-warning';
                                        break;
                                    case 'Suivi':
                                        markerClass = 'bg-success';
                                        break;
                                    default:
                                        markerClass = 'bg-info';
                                }

                                html += `
                                    <div class="timeline-item">
                                        <div class="timeline-marker ${markerClass}"></div>
                                        <div class="timeline-content">
                                            <h6 class="timeline-title">${item.time} - ${item.type}</h6>
                                            <p class="timeline-description">${item.patientName} - ${item.description}</p>
                                        </div>
                                    </div>
                                `;
                            });
                        }

                        $('#schedule-content').html(html);
                        $('#schedule-content').show();
                    } else {
                        $('#schedule-content').html('<div class="alert alert-warning">Impossible de charger la plannification</div>');
                        $('#schedule-content').show();
                        console.error('Erreur lors du chargement de la plannification:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#schedule-loading').hide();
                    $('#schedule-content').html('<div class="alert alert-warning">Impossible de charger la plannification</div>');
                    $('#schedule-content').show();
                    console.error('Erreur lors du chargement de la plannification:', error);
                }
            });
        }
    </script>
}

@section Styles {
    <style>
        .bg-purple {
            background-color: #6f42c1 !important;
        }

        .bg-purple-darker {
            background-color: #5e37a6 !important;
        }

        .bg-success-darker {
            background-color: #17a673 !important;
        }

        .bg-info-darker {
            background-color: #2098a8 !important;
        }

        .bg-warning-darker {
            background-color: #dda20a !important;
        }

        .opacity-50 {
            opacity: 0.5;
        }

        .opacity-75 {
            opacity: 0.75;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }

            .timeline-item:not(:last-child)::before {
                content: '';
                position: absolute;
                left: -22px;
                top: 20px;
                width: 2px;
                height: 100%;
                background-color: #e9ecef;
            }

        .timeline-marker {
            position: absolute;
            left: -30px;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #e9ecef;
        }

        .timeline-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .timeline-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0;
        }

        .card-body .btn {
            transition: all 0.3s ease;
        }

            .card-body .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

        .table-hover tbody tr:hover {
            background-color: rgba(0,123,255,0.1);
        }

        .card-footer a.stretched-link {
            text-decoration: none;
        }
    </style>
}